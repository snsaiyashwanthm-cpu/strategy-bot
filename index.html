<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StrategyVerse AI - Proposal Generator</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. PptxGenJS for PowerPoint Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.js"></script>
    
    <style>
        /* AESTHETIC CHANGE: Use a modern 'Inter' font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            color: #e0e0e0;
        }
        /* AESTHETIC CHANGE: Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* AESTHETIC CHANGE: Custom styles for form inputs */
        .form-input, .form-select {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* AESTHETIC CHANGE: Custom dropdown arrow */
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Prose styles for the generated Markdown output */
        .prose-custom {
            color: #cbd5e1; /* slate-300 */
            max-width: none;
        }
        .prose-custom h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1rem;
            margin-top: 2rem;
            border-bottom: 1px solid #334155; /* slate-700 */
            padding-bottom: 0.5rem;
        }
        .prose-custom h3 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #e2e8f0; /* slate-200 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .prose-custom h4 {
            color: #94a3b8; /* slate-400 */
            font-weight: 600;
            font-size: 1.1em;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }
        .prose-custom p {
            margin-bottom: 1em;
        }
        .prose-custom ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1em;
        }
        .prose-custom li {
            padding-left: 0.5rem;
            margin-bottom: 0.5em;
        }
        .prose-custom strong {
            color: #ffffff; /* white */
            font-weight: 600;
        }
        .prose-custom a {
            color: #60a5fa; /* blue-400 */
            text-decoration: underline;
        }
        /* Styles for Markdown Tables */
        .prose-custom table {
            width: 100%;
            margin-top: 1em;
            margin-bottom: 1em;
            border-collapse: collapse;
        }
        .prose-custom th, .prose-custom td {
            border: 1px solid #475569; /* slate-600 */
            padding: 0.5rem 0.75rem;
            color: #cbd5e1; /* slate-300 */
        }
        .prose-custom th {
            background-color: #334155; /* slate-700 */
            font-weight: 600;
            color: #e2e8f0; /* slate-200 */
        }

    </style>
</head>
<body class="bg-slate-950">

    <!-- AESTHETIC CHANGE: Live Canvas Background -->
    <canvas id="live-background" class="fixed top-0 left-0 w-full h-full z-0"></canvas>

    <!-- Main Content Container -->
    <div class="relative min-h-screen w-full flex items-center justify-center p-4 md:p-8 z-10">
        <div class="w-full max-w-4xl z-10">
            
            <div class="text-center mb-6">
                <!-- AESTHETIC CHANGE: Gradient Header -->
                <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
                    StrategyVerse AI
                </h1>
                <p class="text-lg text-gray-400">Your AI Partner for GTM & Strategy Proposals</p>
            </div>

            <!-- Main App Card -->
            <div class="bg-slate-900 bg-opacity-70 backdrop-blur-lg rounded-xl shadow-2xl overflow-hidden ring-1 ring-white/10" id="tab-container">
                <div class="flex border-b border-slate-700">
                    <button id="tab-btn-generator" class="flex-1 py-4 px-6 text-center font-semibold text-white border-b-2 border-blue-500 transition-all duration-300">Proposal Generator</button>
                    <button id="tab-btn-help" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-white transition-all duration-300">Help & Support ðŸ’¬</button>
                </div>

                <!-- TAB 1: PROPOSAL GENERATOR -->
                <div id="tab-content-generator" class="p-6 md:p-8">
                    <!-- 
                      FEATURE 1: "GUIDED INPUT"
                    -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Client Industry -->
                        <div>
                            <label for="client-industry" class="block text-sm font-medium text-gray-300 mb-2">Client Industry</label>
                            <input type="text" id="client-industry" class="form-input w-full" placeholder="e.g., TMT - Telecom">
                        </div>
                        
                        <!-- FEATURE 2: "PERSONA SELECTOR" -->
                        <div>
                            <label for="client-persona" class="block text-sm font-medium text-gray-300 mb-2">Select Strategic Persona</label>
                            <select id="client-persona" class="form-select w-full">
                                <option value="Aggressive Growth">Aggressive Growth (Market Entry, GTM, TAM)</option>
                                <option value="Efficiency & Optimization">Efficiency & Optimization (Cost-Cutting, OpEx)</option>
                                <option value="Risk & Resilience">Risk & Resilience (Cybersecurity, Supply Chain)</option>
                            </select>
                        </div>
                        
                        <!-- Core Objective -->
                        <div class="md:col-span-2">
                            <label for="client-objective" class="block text-sm font-medium text-gray-300 mb-2">Core Client Objective / Email</label>
                            <textarea id="client-objective" rows="6" class="form-input w-full" placeholder="e.g., We need to find new revenue streams for 5G..."></textarea>
                        </div>
                        
                        <!-- Known Context -->
                        <div class="md:col-span-2">
                            <label for="client-context" class="block text-sm font-medium text-gray-300 mb-2">Known Context / Competitors (Optional)</label>
                            <textarea id="client-context" rows="2" class="form-input w-full" placeholder="e.g., Losing market share to..."></textarea>
                        </div>
                    </div>
                    
                    <!-- AESTHETIC CHANGE: Upgraded "Glow" Button -->
                    <button id="generate-btn" class="mt-6 w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/50 shadow-lg shadow-blue-500/30">
                        Generate Proposal Blueprint
                    </button>
                    
                    <!-- "UNBEATABLE" FEATURE: "PPT EXPORT" BUTTON -->
                    <button id="download-btn" class="hidden mt-4 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-slate-500/50">
                        Download .pptx Blueprint
                    </button>

                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="hidden my-6 text-center">
                        <div role="status">
                            <svg aria-hidden="true" class="inline w-10 h-10 text-gray-600 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                                <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                            </svg>
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p id="loading-text" class="mt-4 text-gray-400">The AI Partner is running its analysis... (This may take 30-60 seconds)</p>
                    </div>

                    <!-- Main Output Area - NEW: SIMPLIFIED -->
                    <div id="output-container" class="mt-6 prose-custom">
                        <!-- The entire Markdown response will be rendered here -->
                    </div>
                </div>

                <!-- TAB 2: HELP & SUPPORT -->
                <div id="tab-content-help" class="p-6 md:p-8 hidden">
                    <h2 class="text-2xl font-bold text-white mb-4">Help & Support ðŸ’¬</h2>
                    <p class="text-gray-300 mb-4">This is a fully-functional help bot. Ask it any questions about how to use the tool, what the AI does, or our firm's capabilities.</p>
                    <iframe
                        src="https://www.chatbase.co/chatbot-iframe/au9YsHjES4gc3mqHjPrOK"
                        style="width: 100%; height: 600px; border: none; border-radius: 8px;"
                        title="Help Chatbot"
                    ></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="modal" class="hidden fixed inset-0 bg-black/70 z-40 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-slate-800 rounded-lg shadow-2xl p-6 z-50 w-full max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Close</button>
        </div>
    </div>


    <script>
        // ----------------------------------------
        // SECTION 1: LIVE CANVAS BACKGROUND
        // ----------------------------------------
        const canvas = document.getElementById('live-background');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        const colors = ['rgba(59, 130, 246, 0.3)', 'rgba(139, 92, 246, 0.3)', 'rgba(16, 185, 129, 0.3)'];
        class Particle {
            constructor(x, y, directionX, directionY, size) {
                this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size;
                this.color = colors[Math.floor(Math.random() * colors.length)];
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color; ctx.fill();
            }
            update() {
                if (this.x > canvas.width || this.x < 0) { this.directionX = -this.directionX; }
                if (this.y > canvas.height || this.y < 0) { this.directionY = -this.directionY; }
                this.x += this.directionX; this.y += this.directionY;
                this.draw();
            }
        }
        function init() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((canvas.width - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((canvas.height - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * 0.4) - 0.2;
                let directionY = (Math.random() * 0.4) - 0.2;
                particlesArray.push(new Particle(x, y, directionX, directionY, size));
            }
        }
        function connect() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) +
                        ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                    if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                        opacityValue = 1 - (distance / 20000);
                        ctx.strokeStyle = 'rgba(191, 219, 254,' + opacityValue * 0.1 + ')'; // Faint blue lines
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }
        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
            }
            connect();
        }
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            init();
        });
        init();
        animate();

        // ----------------------------------------
        // SECTION 2: UI & APP LOGIC
        // ----------------------------------------
        
        let generatedMarkdown = ""; // This will hold the full Markdown response

        // --- Get all UI elements ---
        const tabBtnGen = document.getElementById('tab-btn-generator');
        const tabBtnHelp = document.getElementById('tab-btn-help');
        const tabContentGen = document.getElementById('tab-content-generator');
        const tabContentHelp = document.getElementById('tab-content-help');
        
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        
        const clientIndustry = document.getElementById('client-industry');
        const clientPersona = document.getElementById('client-persona');
        const clientObjective = document.getElementById('client-objective');
        const clientContext = document.getElementById('client-context');
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');
        const outputContainer = document.getElementById('output-container'); // NEW: Single output
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        // --- Tab Switching Logic ---
        tabBtnGen.addEventListener('click', () => {
            tabContentGen.classList.remove('hidden');
            tabContentHelp.classList.add('hidden');
            tabBtnGen.classList.add('border-blue-500', 'text-white');
            tabBtnGen.classList.remove('text-gray-500');
            tabBtnHelp.classList.remove('border-blue-500', 'text-white');
            tabBtnHelp.classList.add('text-gray-500');
        });
        tabBtnHelp.addEventListener('click', () => {
            tabContentHelp.classList.remove('hidden');
            tabContentGen.classList.add('hidden');
            tabBtnHelp.classList.add('border-blue-500', 'text-white');
            tabBtnHelp.classList.remove('text-gray-500');
            tabBtnGen.classList.remove('border-blue-500', 'text-white');
            tabBtnGen.classList.add('text-gray-500');
        });

        // --- Attach Event Listeners ---
        generateBtn.addEventListener('click', handleGenerate);
        downloadBtn.addEventListener('click', handlePptxExport);
        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        // ----------------------------------------
        // SECTION 3: RAG KNOWLEDGE BASE
        // ----------------------------------------

        // This is our "no-compromise" solution. The full RAG lives here in the browser.
        const RAG_KNOWLEDGE_BASE = [
            {
                id: "cs1_gen_ai_saas",
                keywords: ["gen ai", "saas", "tech", "b2b", "roadmap", "assessment", "support", "r&d", "coe"],
                content: `
                File: case_study_1.txt (Gen AI Strategy)
                Project: Generative AI Strategic Assessment & Enterprise-Wide Roadmap
                Client: Global SaaS Leader (Tech / B2B)
                Problem: The client's board was concerned about being disrupted by Gen AI. The firm had no central strategy, and multiple departments were starting "random acts of AI" (e.g., ad-hoc ChatGPT subscriptions) with no clear ROI, creating data security risks and wasted, uncoordinated spend.
                Our Role (Strategy/Advisory):
                1.  **Phase 1: Gen AI Readiness & Maturity Assessment (Weeks 1-3):** We benchmarked the client's data maturity, tech stack (current data-lakes, CRM, ERP), and internal talent against their 3 key competitors (e.g., Salesforce, Oracle). This identified critical gaps in their data governance and internal skillsets.
                2.  **Phase 2: Value-Chain Analysis & Use Case Prioritization (Weeks 4-6):** We ran C-suite and VP-level workshops across 5 business units (Marketing, Sales, R&D, Support, HR). We mapped their entire value chain and identified 45+ potential Gen AI use cases. We then applied a custom scoring matrix (Value vs. Feasibility vs. Risk) to prioritize 3 "high-impact, low-effort" initiatives: 
                    (a) L1/L2 Customer Support Automation
                    (b) AI-Powered "Agent Co-pilot" for L3 support (to reduce issue resolution time)
                    (c) AI-Augmented Code Generation & Review for R&D.
                3.  **Phase 3: Business Case & Financial Model (Weeks 7-8):** We developed the end-to-end business case for the 3 prioritized initiatives. Our model showed a $2.2M initial investment could yield a 30% reduction in support costs (OpEx) and a 20-point CSAT increase within 18 months.
                4.  **Phase 4: Strategic Roadmap & "Center of Excellence" (CoE) Design (Weeks 9-12):** We delivered a 24-month strategic implementation roadmap, which included:
                    (a) A "Build vs. Buy vs. Partner" framework for the core AI platform.
                    (b) A detailed vendor-agnostic technology architecture (recommending a Vector DB, etc.).
                    (c) The full operating model and charter for a new "AI Center of Excellence" (CoE) to govern all future AI projects, manage data, and ensure ethical compliance.
                Result: Our business case was presented to the board, securing the full $2.2M budget. The client is now following our roadmap, starting with the "Agent Co-pilot" initiative, which is on track to reduce agent onboarding time by 50%.
                `
            },
            {
                id: "cs2_5g_gtm_telecom",
                keywords: ["5g", "gtm", "go-to-market", "telecom", "b2b", "market sizing", "tam", "sam", "som", "manufacturing", "logistics", "healthcare"],
                content: `
                File: case_study_2.txt (5G GTM Strategy)
                Project: 5G & Private Network (B2B) Go-to-Market Strategy & Market Sizing
                Client: Tier-1 National Telecom Carrier (Telecom)
                Problem: The client had invested over $10B in 5G spectrum (CapEx) with almost zero net-new consumer revenue. The board demanded a credible strategy to monetize this investment by unlocking new, high-margin B2B revenue streams.
                Our Role (Strategy/Advisory):
                1.  **Market Opportunity Analysis & Sizing (TAM/SAM/SOM):** We conducted a 6-week market research study, sizing the total addressable B2B market (TAM) for 5G services at $80B by 2030. We identified "Private 5G" and "Multi-Access Edge Compute (MEC)" as the two largest and highest-margin value pools.
                2.  **Vertical Prioritization & Deep-Dive:** We analyzed 8 industry verticals (Manufacturing, Logistics, Healthcare, Retail, etc.). We ran a quantitative model to score each vertical based on "Need" (e.g., requires low-latency automation) and "Willingness to Pay." Our analysis *conclusively* recommended 3 high-potential "anchor" segments to target first: 
                    (a) Smart Manufacturing (for robotics & predictive maintenance)
                    (b) Logistics/Ports (for asset tracking & automated guided vehicles)
                    (c) Tele-health (for remote diagnostics & AR-assisted surgery).
                3.  **Strategic GTM Plan & Business Model:** We developed the complete GTM plan. This was not just a report; it was an operational blueprint. It included:
                    (a) Partnership Model Advisory (e.g., how to partner with AWS, Microsoft Azure, and Siemens).
                    (b) Pricing & Packaging Strategy (e.g., "Good-Better-Best" tiers for Private 5G).
                    (c) Sales Force Enablement (e.g., how to re-train their sales team from selling SIM cards to selling complex "solution-based" 5G services).
                4.  **Financial Modeling:** We built the 5-year financial model for the new "B2B Solutions" division, projecting a $750M new revenue pipeline by Year 3.
                Result: Our strategy was adopted in full by the board. The client launched two new B2B service lines. Using our "anchor client" GTM plan, they successfully secured a flagship $30M "Smart Factory" Private 5G contract with a major automotive manufacturer within 9 months.
                `
            },
            {
                id: "cs3_media_churn",
                keywords: ["media", "entertainment", "churn", "subscriber", "retention", "analytics", "market research", "content", "streaming"],
                content: `
                File: case_study_3.txt (Media Subscriber Strategy)
                Project: Content Strategy & Subscriber Churn Reduction (Market Research & Analysis)
                Client: Major Media & Entertainment Studio (Media)
                Problem: The client's new streaming platform (a "Netflix-killer") was facing a disastrously high subscriber churn rate of 8% per month. Their multi-million dollar content acquisition budget was based on "gut-feel" and executive taste, not data, leading to a terrible content-ROI.
                Our Role (Strategy/Advisory):
                1.  **Data-Driven Churn Analysis (Market Research):** We performed a deep-dive data analysis of their 15M+ subscriber base. We analyzed viewing habits, content preferences, and session data to identify the key *leading indicators* of churn.
                2.  **Key Insight Generation:** Our analysis discovered two critical, non-obvious facts:
                    (a) Churn was *not* driven by a lack of "blockbusters." It was driven by a failure to engage users *after* they finished the one show they signed up for.
                    (b) Subscribers who watched 2 or more "niche" titles (e.g., a specific sub-genre of sci-fi) had a 5x higher retention rate.
                3.  **Content Strategy Recommendation:** Based on this data, we advised the client to stop "outbidding" Netflix for A-list blockbusters. Instead, we recommended they shift 20% of their acquisition budget (approx. $100M) from "Blockbuster" to 3 specific "high-value" niche content genres that our analysis showed drove the highest retention and "LTV" (Lifetime Value).
                4.  **Retention Program Strategy:** We provided a strategic framework for a new "proactive retention" program, advising the marketing team on *which* offers to send (e.g., "1-month free") to *which* "at-risk" segments for maximum impact and minimal margin loss.
                Result: The client adopted our new data-driven content-spend model. Our strategy directly led to a 12% reduction in subscriber churn (saving an estimated $40M annually) and a 25% improvement in their content-acquisition ROI.
                `
            },
            {
                id: "cs4_industry_4.0_manufacturing",
                keywords: ["industry 4.0", "manufacturing", "automotive", "electronics", "oee", "smart factory", "digital twin", "iot", "predictive maintenance"],
                content: `
                File: case_study_4.txt (Industry 4.0 Strategy)
                Project: "Smart Factory" (Industry 4.0) Strategic Roadmap & OEE Benchmarking
                Client: Automotive Parts Manufacturer (Electronics/Industrial)
                Problem: The client's OEE (Overall Equipment Effectiveness) was stagnant at 60%, 15 points behind their best-in-class competitors. This was causing them to lose bids and suffer from unplanned downtime. They knew "Industry 4.0" was the answer but had no idea where to start.
                Our Role (Strategy/Advisory):
                1.  **OEE Benchmarking & Gap Analysis:** We conducted a 4-week on-site diagnostic of their 5 key production lines. We benchmarked their OEE, scrap rates, and downtime against 20 competitors to identify and *quantify* the "OEE gap."
                2.  **Value-Driver Identification:** Our analysis proved that 70% of the OEE gap was from "unplanned machine downtime" on their CNC milling machines. We identified Predictive Maintenance (PdM) as the #1, highest-ROI value-driver, not a "full-scale digital twin" (which they *thought* they needed).
                3.  **Industry 4.0 Strategic Roadmap:** We developed a pragmatic, 3-year "Smart Factory" strategy. We created the detailed business case showing a 40% reduction in downtime was achievable with a $1.9M pilot program for PdM, which would pay for itself in 9 months.
                4.  **Vendor Landscape & Advisory:** We provided an independent advisory brief on the "IoT / Digital Twin / PdM" vendor landscape, shortlisting 3 top vendors (e.g., Siemens, Rockwell, an AI startup) to guide their procurement and partnership strategy, saving them from vendor lock-in.
                Result: The board approved the $1.9M pilot based *directly* on our business case. The client followed our strategic roadmap, and increased OEE from 60% to 78% in 2 years, making them competitive again.
                `
            },
            {
                id: "cs5_semiconductor_rd",
                keywords: ["semiconductor", "r&d", "ai", "eda", "chip design", "electronics", "fabless", "reinforcement learning"],
                content: `
                File: case_study_5.txt (Semiconductor R&D Strategy)
                Project: AI in R&D - Effectiveness & Strategy (Market Research)
                Client: Fabless Semiconductor Designer
                Problem: Soaring R&D costs and multi-year design cycles for new 3nm ASICs. The "verification" phase (bug-hunting) was a major bottleneck, and competitors were getting to market 6-9 months faster.
                Our Role (Strategy/Advisory):
                1.  **R&D Lifecycle Benchmarking:** We analyzed their 24-month chip design lifecycle, benchmarking their "time-to-tapeout" against 5 key competitors. We identified the verification phase as the primary bottleneck, costing 30% more time than the industry best-in-class.
                2.  **AI in R&D Opportunity Sizing (Market Research):** We researched and presented the entire "AI in EDA (Electronic Design Automation)" landscape. We identified "AI-based verification" and "Reinforcement Learning (RL) for chip layout" as two breakthrough strategic opportunities. We quantified a potential 30% reduction in cycle time.
                3.  **R&D Data Strategy Advisory:** We delivered the strategic advisory for a new R&D data platform. We outlined the "must-have" capabilities to enable this (e.g., centralizing all R&D, verification, and fab data) and provided a "data-governance" framework for them to implement.
                Result: Our strategic recommendations were adopted by the CTO. The client initiated a new "AI for R&D" program that is on track to achieve a 10% improvement in PPA (Power, Performance, Area) on its next-gen chip.
                `
            },
            {
                id: "cs6_cloud_strategy_finance",
                keywords: ["cloud", "tco", "financial model", "bank", "financial services", "aws", "azure", "hybrid cloud", "finops", "secops", "coe"],
                content: `
                File: case_study_6.txt (Cloud Strategy & TCO Analysis)
                Project: Hybrid Cloud Transformation Strategy & Financial Modeling
                Client: Legacy Retail Bank (Financial Services)
                Problem: The on-premise mainframe infrastructure was a strategic bottleneck. Dev cycles for new digital banking apps were 6+ months, infrastructure costs were high, and they couldn't compete with new digital-native "fintech" banks.
                Our Role (Strategy/Advisory):
                1.  **TCO & Application Portfolio Analysis:** We analyzed their 100+ critical applications for cloud-readiness. We created a detailed TCO (Total Cost of Ownership) financial model that proved a hybrid-cloud model could reduce their infrastructure costs by 35% over 5 years.
                2.  **Hybrid Cloud Strategy (Advisory):** We advised on the optimal "to-be" hybrid strategy. Our recommendation was to keep the core ledger system on-prem (for regulatory compliance) but migrate all customer-facing apps to a "multi-cloud" mix of AWS (for new app dev) and Azure (for their data warehouse).
                3.  **Cloud Operating Model Design (Advisory):** We delivered the strategic framework for a new "Cloud Center of Excellence" (CCOE). This was an organizational blueprint, advising on the new governance, FinOps (cost management), and SecOps processes required to manage a complex multi-cloud environment.
                Result: The client adopted our strategy, which unlocked a 70% faster "time-to-market" for new digital products (from 6 months to 3 weeks).
                `
            },
            {
                id: "cs7_cybersecurity_zero_trust",
                keywords: ["cybersecurity", "zero trust", "risk", "ransomware", "healthcare", "hipaa", "soc", "siem", "breach", "assessment"],
                content: `
                File: case_study_7.txt (Cybersecurity Strategy)
                Project: "Zero Trust" Security Strategy & Post-Breach Roadmap
                Client: Large Healthcare Provider
                Problem: A major ransomware attack exposed 1M+ patient records (PHI). The board had lost confidence in the CISO. Their legacy "castle-and-moat" security model (firewalls, VPNs) was proven obsolete.
                Our Role (Strategy/Advisory):
                1.  **Post-Breach Capability Assessment (Advisory):** We conducted a rapid 3-week assessment of their entire security posture, people, and processes. We benchmarked them against the NIST "Zero Trust" framework.
                2.  **Strategic Gap Analysis:** We identified 3 critical, high-risk gaps: (a) weak identity management (everyone was an "admin"), (b) a "flat" network allowing the ransomware to spread (lateral movement), and (c) a slow, reactive Security Operations Center (SOC).
                3.  **"Zero Trust" Strategic Roadmap:** We developed the 18-month strategic roadmap to move from their legacy model to a "Zero Trust" posture ("never trust, always verify"). This was a step-by-step plan for implementing new policies like identity-aware proxies and micro-segmentation.
                4.  **SOC Operating Model Advisory:** We advised on the new SOC operating model and provided the vendor-agnostic capability matrix for the AI-powered SIEM/SOAR tech stack required to reduce "mean time to detect" a threat from days to minutes.
                Result: Our strategy and roadmap were presented directly to the board and adopted in full. The client successfully met all HIPAA regulatory compliance requirements within 12 months.
                `
            },
            {
                id: "cs8_telecom_opex_aiops",
                keywords: ["telecom", "opex", "cost reduction", "efficiency", "aiops", "ai", "automation", "network", "predictive maintenance"],
                content: `
                File: case_study_8.txt (Telecom OpEx Reduction Strategy)
                Project: Network OpEx Reduction & AIOps Strategy
                Client: Tier-1 Mobile Network Operator
                Problem: Extremely high operating costs (OpEx) for managing their 50,000+ cell towers. Network faults were handled *reactively*, requiring expensive, inefficient emergency "truck rolls" (dispatching technicians).
                Our Role (Strategy/Advisory):
                1.  **OpEx Driver Analysis (Market Research):** We analyzed all network OpEx drivers and found that "truck rolls" represented a $50M+ annual cost and were the #1 source of inefficiency.
                2.  **AIOps Business Case (Advisory):** We developed the complete business case for an "AIOps" (AI for IT Operations) strategy. We proved that a *predictive* maintenance model (using AI to predict tower failures *before* they happen) could reduce truck rolls by 30%.
                3.  **Data Strategy Advisory:** We outlined the data strategy required to enable AIOps. This involved advising them on how to centralize their 1,000s of disparate data streams (equipment logs, weather data, network alarms) into a unified data lake to feed the AIOps model.
                Result: The client adopted our strategy. Our business case directly led to a 30% reduction in "truck rolls," saving them an estimated $50M annually.
                `
            },
            {
                id: "cs9_media_personalization",
                keywords: ["media", "subscriber", "personalization", "market research", "analytics", "retention", "streaming", "publisher"],
                content: `
                File: case_study_9.txt (Media Subscriber Strategy - Market Research)
                Project: Digital Subscriber Acquisition & Retention Strategy
                Client: Global News & Media Publisher
                Problem: A forced strategic shift from ad-based revenue to subscriptions. Their generic "most popular articles" content was-failing to engage users or drive conversions.
                Our Role (Strategy/Advisory - Market Research):
                1.  **Market Research & User Segmentation:** We conducted an-depth market research study, including 20 stakeholder interviews and a survey of 5,000 readers, to segment their 10M+ user base. We identified a "high-value" niche segment ("Passionate Professionals") that was 5x more likely to subscribe.
                2.  **Personalization Strategy (Advisory):** We developed the strategy to move from a "one-size-fits-all" model to a "hyper-personalization" engine to target this new segment.
                3.  **Roadmap & Recommendation:** We delivered the strategic roadmap for a new recommender system and A/B testing framework. We advised them on *how* to leverage their first-party data to create a "sticky" user experience.
                Result: Our strategy led to a 40% increase in click-through-rate (CTR) on recommended articles and a 5% lift in subscription conversions.
                `
            },
            {
                id: "cs10_electronics_supply_chain",
                keywords: ["electronics", "supply chain", "risk", "resilience", "digital twin", "semiconductor", "automotive", "assessment"],
                content: `
                File: case_study_10.txt (Electronics Supply Chain Strategy)
                Project: Supply Chain Resilience & Risk Advisory
                Client: Top-5 Consumer Electronics Company
                Problem: Extreme supply chain volatility. They had "stock-outs" on 3 flagship products (costing them an estimated $500M in revenue) because they were "blind" to disruptions in their Tier-2 and Tier-3 supplier base in Asia.
                Our Role (Strategy/Advisory):
                1.  **Supply Chain Vulnerability Analysis:** We conducted an-depth analysis of their multi-tier supply chain. We mapped their top 100 critical components (chips, screens) and identified 5 "single-source, high-risk" supplier vulnerabilities.
                2.  **Strategic Recommendation (Advisory):** We recommended a new supply chain strategy based on two pillars:
                    (a) A "Digital Twin" of their supply chain for real-time visibility.
                    (b) An "AI Risk Sensing" platform to monitor 1M+ data sources (news, weather, shipping, labor strikes) to predict disruptions.
                3.  **Business Case & Modeling:** We modeled the ROI for this new strategy. We proved it could prevent 60% of stock-out events by providing 3-4 weeks of advance warning, delivering a 10x ROI on the project cost.
                Result: The client's COO adopted our recommendation. The new "AI Risk Sensing" platform is now a core part of their quarterly S&OP (Sales & Operations Planning) process.
                `
            }
        ];

        // -----------------------------------------------------------------
        // SECTION 4: "SMART RAG" SEARCH FUNCTION
        // -----------------------------------------------------------------
        function simpleSearch(industry, objective, context) {
            const query = `${industry} ${objective} ${context}`.toLowerCase();
            const keywords = query.split(/\s+/).filter(word => word.length > 3);
            if (keywords.length === 0) { // Fallback if query is too short
                return RAG_KNOWLEDGE_BASE.slice(0, 2).map(doc => doc.content).join('\n\n---\n\n');
            }

            const scores = RAG_KNOWLEDGE_BASE.map(doc => {
                let score = 0;
                const docKeywords = doc.keywords.join(' ');
                for (const keyword of keywords) {
                    if (docKeywords.includes(keyword)) {
                        score++;
                    }
                }
                return { ...doc, score };
            });

            const top2Docs = scores.sort((a, b) => b.score - a.score).slice(0, 2);
            return top2Docs.map(doc => doc.content).join('\n\n---\n\n');
        }

        // -----------------------------------------------------------------
        // SECTION 5: AI "BRAIN" (PROMPT & SCHEMA)
        // -----------------------------------------------------------------
        
        // NEW: We've abandoned the complex JSON schema for Part 2.
        // We now ask for JSON for Part 1 (reliable) and Markdown for Part 2 (reliable).
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "part1_analysis": {
                    type: "OBJECT",
                    properties: {
                        "core_problem": { type: "STRING" },
                        "scope_of_work": { type: "STRING" },
                        "pricing_team": { type: "STRING" },
                        "assumptions": { type: "ARRAY", items: { type: "STRING" } },
                        "risks": { type: "ARRAY", items: { type: "STRING" } },
                        "stakeholder_analysis": { type: "ARRAY", items: { type: "STRING" } },
                        "objection_handling": { type: "ARRAY", items: { type: "STRING" } },
                    },
                },
                // PART 2 IS NOW A SIMPLE STRING. THIS IS THE FIX.
                "part2_blueprint_markdown": { 
                    type: "STRING" 
                }
            }
        };

        // ----------------------------------------
        // SECTION 6: MAIN APP LOGIC
        // ----------------------------------------
        
        // --- API Key (This MUST be a RESTRICTED key) ---
        const API_KEY = "AIzaSyDUlVamN2fCLWHLa_9fW3B1Eq6nQ2V90tc"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-latest:generateContent?key=${API_KEY}`;
        
        async function handleGenerate() {
            // 1. Get values from all inputs
            const industry = clientIndustry.value;
            const persona = clientPersona.value;
            const objective = clientObjective.value;
            const context = clientContext.value;

            if (!objective) {
                showModal("Input Required", "Please fill in the 'Core Client Objective' field before generating.");
                return;
            }
            if (API_KEY === "PASTE_YOUR_NEW_RESTRICTED_API_KEY_HERE") {
                showModal("API Key Missing", "ERROR: The developer has not pasted the restricted API key into the index.html file.");
                return;
            }

            // 2. Set loading state
            loadingSpinner.classList.remove('hidden');
            loadingText.innerText = "The AI Partner is running its analysis... (This may take 30-60 seconds)"; 
            downloadBtn.classList.add('hidden');
            outputContainer.innerHTML = ""; // Clear the entire output container
            generateBtn.disabled = true;
            generateBtn.innerText = "Generating...";
            generatedMarkdown = ""; // Clear old Markdown data

            try {
                // 3. --- RUN THE "SMART RAG" SEARCH (CLIENT-SIDE) ---
                const relevantCaseStudies = simpleSearch(industry, objective, context);
                
                // 4. This is the "A++" Senior Partner Meta-Prompt (SIMPLIFIED AND FIXED)
                const finalPrompt = `
                    # YOUR ROLE
                    You are a 3-person team:
                    1.  **A Senior MBB-Style Strategy Consultant:** Master of storytelling and problem-framing.
                    2.  **A Proposal Team Lead:** Master of persuasive, negotiation-ready documents.
                    3.  **A Research Director:** Master of data, rigor, and analysis.

                    # YOUR STYLE (MANDATORY)
                    ### style ###
                    Avoid fancy jargon. Write normally. Use clear, simple, and direct language.
                    You are forbidden to use complex English words.
                    But you will be penalized & fined $1000 if you use the words from the ### ban list ###. 
                    If you use one word from the list, I will stop the generation right away.

                    ### ban list ###
                    Hurdles, Bustling, Harnessing, Unveiling the power, Realm, Depicted, Demistify, Insurmountable, New Era, Poised, Unravel, Entanglement, Unprecedented, Eerie connection, unliving, Beacon, Unleash, Delve, Enrich, Multifaced, Elevate, Discover, Supercharge, Unlock, Tailored, Elegant, Dive, Ever-evolving, pride, Meticulously, Grappling, Weighing, Picture, Architect, Adventure, Journey, Embark, Navigate, Navigation, dazzle, tapestry
                    ### ban list ###
                    
                    No more "dive," "realm," or "unveiling" nonsense. 
                    Just clear, normal Englishâ€”every time.
                    _____________

                    # YOUR KNOWLEDGE (Proprietary & Relevant)
                    This is our firm's proprietary list of *relevant* past engagements. You MUST use this as social proof.
                    --- RELEVANT CASE STUDIES ---
                    ${relevantCaseStudies}
                    --- END OF CASE STUDIES ---

                    # YOUR INPUT
                    A new client objective:
                    ---
                    **Client Industry:** ${industry || 'Not Provided'}
                    **Core Objective:** ${objective}
                    **Known Context:** ${context || 'Not Provided'}
                    ---

                    # YOUR PERSONA (MANDATORY)
                    You MUST adopt the following strategic persona for this proposal: **${persona}**
                    * If 'Aggressive Growth', focus on market entry, GTM, TAM/SAM, new products, and gaining market share.
                    * If 'Efficiency & Optimization', focus on cost reduction, process automation, OpEx, and profitability.
                    * If 'Risk & Resilience', focus on cybersecurity, supply chain, regulatory compliance, and business continuity.

                    # YOUR CORE TASK
                    Generate a comprehensive, two-part response. You MUST NOT hallucinate.
                    You MUST return *ONLY* a single, valid JSON object that adheres to the provided schema. Do not add any text before or after the JSON.

                    # --- PART 1: ENGAGEMENT ANALYSIS (JSON) ---
                    (Fill this part of the JSON based on the client input and your persona.)
                    
                    **1. Analysis of Client Requirements (The Core Problem):**
                       * Infer the 'true' decision problem as a single, precise question.
                    **2. Proposed Scope of Work:**
                       * Define the boundaries of the engagement.
                    **3. "UNBEATABLE" FEATURE 1 (MBB Pricing & Team):**
                       * Create a 'pricing_team' string. Propose a realistic team structure (e.g., 1 Partner, 1 Principal, 2 Associates) and a 12-week, 3-phase engagement. Calculate a realistic fee (e.g., "$350k - $450k"). Be specific.
                    **4. Key Assumptions:**
                       * List 3-4 key assumptions.
                    **5. Potential Risks & Mitigation:**
                       * List 2-3 key risks.
                    **6. "UNBEATABLE" FEATURE 2 (Stakeholder Analysis):**
                       * Create a 'stakeholder_analysis' list. Identify 3-4 key client stakeholders who must be involved (e.g., "CFO," "VP of Marketing").
                    **7. "UNBEATABLE" FEATURE 3 ("Red Team"):**
                       * Create an 'objection_handling' list. Proactively identify 2-3 tough objections the client might have (e.g., "This is too expensive," "Why not do this in-house?") and provide a clear, persuasive counter-argument for each.
                    
                    # --- PART 2: PPT-READY PROPOSAL BLUEPRINT (MARKDOWN STRING) ---
                    (This part MUST be a single, long string. Generate 15-20 slides in clear, well-formatted Markdown.)
                    (Use "##" for Section Dividers, "###" for slide titles, and "**" for labels like "**Purpose:**". Use "*" for bullets.)

                    ## Section 1: Executive Summary
                    
                    ### Slide 1 (Title Slide)
                    **Section:** Executive Summary
                    **Title:** A Strategic Proposal for [Client's Core Problem]
                    **Purpose:** To...
                    **Key Message:** Our 12-week engagement will deliver...
                    **Key Content:**
                    * [Bullet 1]
                    * [Bullet 2]
                    **Visual Spec:** A clean, professional title slide.
                    **Data Needed:** N/A
                    **Build Guidance:** N/A

                    ### Slide 2 (Executive Summary)
                    **Section:** Executive Summary
                    **Title:** Our Recommendation: A Phased Approach to [Client's Goal]
                    ... (and so on for 15-20 slides) ...

                    ## Section 2: Our Approach
                    ...
                `;

                // 5. Make the API call *from the user's browser*.
                // This has NO timeout.
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: finalPrompt }] }],
                        generationConfig: {
                            responseMfimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData.error.message}. This can happen if your API key is invalid or not restricted to this website's domain.`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    const responseText = data.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(responseText);
                    
                    // Save both parts of the data globally
                    generatedData = parsedData.part1_analysis; 
                    generatedMarkdown = parsedData.part2_blueprint_markdown; 

                    renderHtmlOutput(generatedData, generatedMarkdown); // Render the HTML
                    
                    downloadBtn.classList.remove('hidden'); // Show the download button
                } else {
                    throw new Error("Invalid response structure from API. No candidates found.");
                }

            } catch (error) {
                console.error("Error:", error);
                // This will catch the "Cannot read properties of undefined (reading 'map')"
                // if the API call fails or the JSON is bad.
                showModal("Generation Error", `An error occurred: ${error.message}. This is often due to a malformed JSON response from the AI. Try a slightly simpler prompt or check the console (F12) for details.`);
            } finally {
                // 9. Reset UI
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.innerText = "Generate Proposal Blueprint";
            }
        }

        // --- NEW: Renders both JSON (Part 1) and Markdown (Part 2) ---
        function renderHtmlOutput(p1_data, p2_markdown) {
            // --- Render Part 1 (from JSON) ---
            const p1 = p1_data || {};
            let part1Html = `
                <h2 class="text-2xl font-bold text-white mb-4">Part 1: Engagement Analysis</h2>
                <div class="p-6 bg-slate-800/70 border border-slate-700 rounded-lg text-gray-300 prose-custom max-w-none">
                    
                    <h4>Core Decision Problem:</h4>
                    <p>${p1.core_problem || "Not generated."}</p>

                    <h4>Proposed Scope of Work:</h4>
                    <p>${p1.scope_of_work || "Not generated."}</p>

                    <h4>Proposed Team & Fees:</h4>
                    <p>${p1.pricing_team || "Not generated."}</p>

                    <h4>Key Assumptions:</h4>
                    <ul>${(p1.assumptions || []).map(item => `<li>${item}</li>`).join('')}</ul>

                    <h4>Potential Risks & Mitigation:</h4>
                    <ul>${(p1.risks || []).map(item => `<li>${item}</li>`).join('')}</ul>

                    <h4>Stakeholder Analysis & Alignment:</h4>
                    <ul>${(p1.stakeholder_analysis || []).map(item => `<li>${item}</li>`).join('')}</ul>
                    
                    <h4><span style="color: #f87171;">"Red Team"</span> Objection Handling:</h4>
                    <ul>${(p1.objection_handling || []).map(item => `<li>${item}</li>`).join('')}</ul>
                </div>
            `;
            
            // --- Render Part 2 (from Markdown) ---
            let part2Html = `
                <h2 class="text-2xl font-bold text-white mt-8 mb-4">Part 2: PPT-Ready Proposal Blueprint</h2>
                ${markdownToHtml(p2_markdown || "<p>Part 2 was not generated. The AI may have failed to produce the slide blueprint. Please try again.</p>")}
            `;
            
            // Combine and set the output
            outputContainer.innerHTML = part1Html + part2Html;
        }
        
        // --- NEW: Simple Markdown to HTML converter ---
        function markdownToHtml(md) {
            if (!md) return '';

            let html = md.trim();
            let inList = false;

            return html.split('\n').map(line => {
                line = line.trim();
                let lineHtml = '';

                if (line.startsWith('## ')) { // Section
                    if (inList) { lineHtml += '</ul>'; inList = false; }
                    lineHtml += `<h2>${line.substring(3)}</h2>`;
                } else if (line.startsWith('### ')) { // Slide Title
                    if (inList) { lineHtml += '</ul>'; inList = false; }
                    lineHtml += `<h3>${line.substring(4)}</h3>`;
                } else if (line.startsWith('* ')) { // Bullet
                    if (!inList) { lineHtml += '<ul>'; inList = true; }
                    lineHtml += `<li>${line.substring(2)}</li>`;
                } else if (line.startsWith('**') && line.includes(':**')) { // Bold label
                    if (inList) { lineHtml += '</ul>'; inList = false; }
                    lineHtml += `<p>${line.replace(/\*\*(.*?):\*\*/g, '<strong>$1:</strong>')}</p>`;
                } else if (line.length > 0) { // Paragraph
                    if (inList) { lineHtml += '</ul>'; inList = false; }
                    lineHtml += `<p>${line}</p>`;
                } else {
                    if (inList) { lineHtml += '</ul>'; inList = false; }
                }
                
                return lineHtml;
            }).join('');
        }

        // --- PPT Export Function (REWRITTEN to parse Markdown) ---
        function handlePptxExport() {
            if (!generatedMarkdown) {
                showModal("Error", "No proposal blueprint (Part 2) to export. Please generate a proposal first.");
                return;
            }
            
            showModal("Exporting...", "Generating your .pptx file. This may take a moment.");

            let pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_WIDE';
            pptx.author = 'StrategyVerse AI';
            pptx.company = 'StrategyVerse';
            pptx.title = 'Strategy Proposal';

            // --- Define Slide Styles ---
            const SLIDE_HEADLINE = { x: 0.5, y: 0.25, w: '90%', h: 0.5, fontSize: 24, fontFace: 'Inter', bold: true, color: '00529B' };
            const SLIDE_TITLE = { x: 0.5, y: 0.75, w: '90%', h: 0.4, fontSize: 16, fontFace: 'Inter', color: '31333F' };
            const SLIDE_BODY = { x: 0.5, y: 1.5, w: '90%', h: 5.0, fontSize: 12, fontFace: 'Inter', color: '31333F', bullet: true };
            const SLIDE_NOTES_STYLE = { fontSize: 10, fontFace: 'Inter' };

            // --- Title Slide ---
            let titleSlide = pptx.addSlide();
            titleSlide.addText('Strategy Proposal', { x: 1, y: 2, fontSize: 44, fontFace: 'Inter', bold: true, color: '00529B' });
            titleSlide.addText(`Prepared for: ${clientIndustry.value || 'Valued Client'}`, { x: 1, y: 3, fontSize: 20, fontFace: 'Inter' });
            titleSlide.addNotes("Generated by StrategyVerse AI");

            // --- NEW: Part 1 Analysis Slide ---
            // We read from the *saved JSON*, not the screen
            if (generatedData) {
                let analysisSlide = pptx.addSlide();
                analysisSlide.addText("Executive Summary: Engagement Analysis", { ...SLIDE_HEADLINE, y: 0.2, h: 0.5 });
                const p1 = generatedData; // Use the saved JSON
                let analysisText = [
                    { text: 'Core Decision Problem:', options: { bold: true, breakLine: true, indent: 0, paraSpaceBefore: 10 } },
                    { text: p1.core_problem, options: { breakLine: true } },
                    { text: 'Proposed Scope of Work:', options: { bold: true, breakLine: true, indent: 0, paraSpaceBefore: 10 } },
                    { text: p1.scope_of_work, options: { breakLine: true } },
                    { text: 'Proposed Team & Fees:', options: { bold: true, breakLine: true, indent: 0, paraSpaceBefore: 10 } },
                    { text: p1.pricing_team, options: { breakLine: true } },
                    { text: '"Red Team" Objection Handling:', options: { bold: true, breakLine: true, indent: 0, paraSpaceBefore: 10, color: 'D9534F' } },
                    ...(p1.objection_handling || []).map(item => ({ text: item, options: { bullet: true, indent: 30 } })),
                    { text: 'Stakeholder Analysis:', options: { bold: true, breakLine: true, indent: 0, paraSpaceBefore: 10 } },
                    ...(p1.stakeholder_analysis || []).map(item => ({ text: item, options: { bullet: true, indent: 30 } }))
                ];
                analysisSlide.addText(analysisText, { x: 0.5, y: 1.0, w: '90%', h: 6.0, fontSize: 11, fontFace: 'Inter', color: '31333F' });
            }

            // --- NEW: Parse Markdown for Part 2 Slides ---
            // We split the saved Markdown string by the slide title (###)
            const slides = generatedMarkdown.split('### ');
            slides.shift(); // Remove empty element before the first "###"

            for (const slideText of slides) {
                let pptxSlide = pptx.addSlide();
                
                // Helper to extract text cleanly
                const extract = (regex) => {
                    const match = slideText.match(regex);
                    return match ? match[1].trim() : '';
                };

                // Helper to extract bullets
                const extractBullets = () => {
                    const contentMatch = slideText.match(/\*\*Key Content:\*\*(.*?)(?=\*\*|$)/s);
                    if (!contentMatch) return ['Missing content'];
                    // Split by lines that start with a star
                    return contentMatch[1].split('\n* ')
                                        .map(b => b.replace(/^\*/, '').trim()) // Clean up first bullet
                                        .filter(b => b.length > 0);
                };

                const slideTitle = slideText.substring(0, slideText.indexOf('\n')).trim();
                const section = extract(/\*\*Section:\*\*(.*?)\n/);
                const titleLabel = extract(/\*\*Title:\*\*(.*?)\n/); // This is the title *within* the text
                const purpose = extract(/\*\*Purpose:\*\*(.*?)\n/);
                const keyMessage = extract(/\*\*Key Message:\*\*(.*?)\n/);
                const visualSpec = extract(/\*\*Visual Spec:\*\*(.*?)\n/);
                const dataNeeded = extract(/\*\*Data Needed:\*\*(.*?)\n/);
                const buildGuidance = extract(/\*\*Build Guidance:\*\*(.*?)\n/);
                const keyContent = extractBullets();

                // Add to PPTx
                pptxSlide.addText(keyMessage || "Missing Key Message", SLIDE_HEADLINE);
                pptxSlide.addText(`${section}: ${titleLabel || slideTitle}`, SLIDE_TITLE);
                pptxSlide.addText(keyContent, SLIDE_BODY);
                
                const notes = `
                    VISUAL SPEC:
                    ${visualSpec || 'N/A'}

                    DATA NEEDED:
                    ${dataNeeded || 'N/A'}

                    BUILD GUIDANCE:
                    ${buildGuidance || 'N/A'}
                `;
                pptxSlide.addNotes(notes, SLIDE_NOTES_STYLE);
            }

            // --- Thank You Slide ---
            let thankYouSlide = pptx.addSlide();
            thankYouSlide.addText('Thank You', { x: 1, y: 2.5, fontSize: 44, fontFace: 'Inter', bold: true, color: '00529B' });
            thankYouSlide.addText('StrategyVerse AI - Your Partner in Strategy', { x: 1, y: 3.5, fontSize: 20, fontFace: 'Inter' });
            
            // --- Write the file ---
            pptx.writeFile({ fileName: 'StrategyVerse_Proposal.pptx' });
        }


        // --- Custom Modal (for alerts) ---
        function showModal(title, message) {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modal.classList.remove('hidden');
            
            // Add click-away to close
            const modalBackdrop = document.getElementById('modal');
            modalBackdrop.onclick = (e) => {
                if (e.target.id === 'modal') {
                    modal.classList.add('hidden');
                }
            };
            modalClose.onclick = () => modal.classList.add('hidden');
        }

    </script>
</body>
</html>

